{% extends 'base.html' %}

{% load static %}

{% block contenido %}

      <main role="main" class="main-content">
        <div class="container-fluid">
          <div class="row justify-content-center">
            <div class="col-12">
              <div class="row align-items-center my-3">
                <div class="col">
                  <h2 class="page-title">Calendario</h2>
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#eventModal"><span class="fe fe-plus fe-16 mr-3"></span>Crear cita</button>
                </div>
              </div>
              <div id='calendar'></div>
              <!-- new event modal -->
              <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="varyModalLabel">Crear cita</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body p-4">
                      <form method="post" action="{% url 'registrar_cita' %}">
                        {% csrf_token %}
                        <div class="form-row">
                          <div class="form-group col-md-6">
                            <label for="eventType">Paciente</label>
                            <select id="eventPaciente" class="form-control select2" name="txtPaciente" required>
                              {% for paciente in pacientes %}
                              <option value="{{ paciente.id }}">{{ paciente }}</option>
                              {% endfor %}
                            </select>
                          </div>

                          <div class="form-group col-md-6">
                            <label for="eventType">Especialidad</label>
                            <select id="eventEspecialidad" class="form-control select2" name="txtEspecialidad" required>
                              {% for especialidad in especialidades %}
                              <option value="{{ especialidad.id }}">{{ especialidad }}</option>
                              {% endfor %}
                            </select>
                          </div>

                          <div class="form-group col-md-6">
                            <label for="eventType">Médico</label>
                            <select id="eventMedico" class="form-control select2" name="txtMedico" required>
                              {% for medico in medicos %}
                              <option value="{{ medico.id }}">{{ medico }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="form-group col-md-6">
                            <label for="eventType">Motivo</label>
                            <select id="eventMotivo" class="form-control select2" name="txtMotivo" required>
                              <option value="Sesion de tratamiento">Sesion de tratamiento</option>
                              <option value="Consulta">Consulta</option>
                            </select>
                          </div>
                          <div class="form-group col-md-6">
                            <label for="eventType">Servicio</label>
                            <select id="eventServicio" class="form-control select2" name="txtServicio" required>
                              {% for servicio in servicios %}
                              <option value="{{ servicio.id }}">{{ servicio }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="form-group col-md-6">
                            <label for="inputFch">Fecha</label>
                            <input type="date" class="form-control" id="inputFch" name="txtFecha" required>
                          </div>
                          <div class="form-group col-md-6">
                            <label for="example-time">Hora</label>
                            <input class="form-control" id="example-time" type="time" name="txtHora" required>
                          </div>
                          
                          <div class="form-group col-md-6">
                            <label for="eventType">Duración</label>
                            <select id="eventDuracion" class="form-control select2" name="txtDuracion" required>
                              <option value="45 minutos">45 minutos</option>
                            </select>
                          </div>
                        </div>
                        <div class="modal-footer d-flex justify-content-between">
                          <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="RepeatSwitch" checked>
                            <label class="custom-control-label" for="RepeatSwitch">Todo el día</label>
                          </div>
                          <div>
                            <button type="submit" class="btn btn-primary mr-4">Guardar</button>
                            <a href="{% url 'calendar' %}" class="btn btn-danger">Cancelar</a>
                          </div>
                        </div>
                      </form>
                    </div>

                    
                  </div>
                </div>
              </div> <!-- new event modal -->
            </div> <!-- .col-12 -->
          </div> <!-- .row -->
        </div> <!-- .container-fluid -->
    </main>
    
    <script src="{% static 'js/fullcalendar.js' %}"></script>
    <script src="{% static 'js/es.js' %}"></script>
    <script src="{% static 'js/fullcalendar.custom.js' %}"></script>
    <script>
      /** full calendar */
      var calendarEl = document.getElementById('calendar');
      if (calendarEl)
      {
        document.addEventListener('DOMContentLoaded', function()
        {
          var calendar = new FullCalendar.Calendar(calendarEl,
          {
            plugins: ['dayGrid', 'timeGrid', 'list', 'bootstrap'],
            timeZone: 'UTC',
            themeSystem: 'bootstrap',
            locale: 'es',
            buttonText: {
                today:    'Hoy',
                month:    'Mes',
                week:     'Semana',
                day:      'Día',
                list:     'Agenda'
            },
            header:
            {
              left: 'today, prev, next',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
            },
            buttonIcons:
            {
              prev: 'fe-arrow-left',
              next: 'fe-arrow-right',
              prevYear: 'left-double-arrow',
              nextYear: 'right-double-arrow'
            },
            weekNumbers: true,
            eventLimit: true, // allow "more" link when too many events
            events: '/citas/calendario/',
            eventRender: function(info) {
                var medico = info.event.extendedProps.medico;
                var motivo = info.event.extendedProps.motivo;
                var servicio = info.event.extendedProps.servicio;
                var hora = info.event.extendedProps.hora;
                var paciente = info.event.title;

                // Estructura de Card HTML
                var tooltipContent = `
                    <div class="tooltip-card">
                        <div class="tooltip-header">
                            <span>Cita Médica</span>
                            <small>${hora}</small>
                        </div>
                        <div class="tooltip-body">
                            <strong>Paciente</strong>
                            <div>${paciente}</div>
                            
                            <strong>Médico</strong>
                            <div>${medico}</div>
                            
                            <strong>Servicio / Motivo</strong>
                            <div>${servicio} - ${motivo}</div>
                        </div>
                    </div>
                `;

                $(info.el).tooltip({
                    title: tooltipContent,
                    html: true,
                    placement: 'top',
                    trigger: 'hover',
                    container: 'body'
                });
            }
          });
          calendar.render();
        });
      }
    </script>
    <script src="{% static 'js/jquery.timepicker.js' %}"></script>
    <script>
      $('.select2').select2(
      {
        theme: 'bootstrap4',
      });
      $('.select2-multi').select2(
      {
        multiple: true,
        theme: 'bootstrap4',
      });
      $('.drgpicker').daterangepicker(
      {
        singleDatePicker: true,
        timePicker: false,
        showDropdowns: true,
        locale:
        {
          format: 'DD/MM/YYYY', 
          applyLabel: 'Aplicar',
          cancelLabel: 'Cancelar',
          fromLabel: 'Desde',
          toLabel: 'Hasta',
          customRangeLabel: 'Personalizado',
          daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
          monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
          firstDay: 1
        }
      });
      $('.time-input').timepicker(
      {
        'scrollDefault': 'now',
        'zindex': '9999' /* fix modal open */
      });
      /** date range picker */
      if ($('.datetimes').length)
      {
        $('.datetimes').daterangepicker(
        {
          timePicker: true,
          startDate: moment().startOf('hour'),
          endDate: moment().startOf('hour').add(32, 'hour'),
          locale:
          {
            format: 'M/DD hh:mm A'
          }
        });
      }
      var start = moment().subtract(29, 'days');
      var end = moment();

      function cb(start, end)
      {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
      }
      $('#reportrange').daterangepicker(
      {
        startDate: start,
        endDate: end,
        ranges:
        {
          'Hoy': [moment(), moment()],
          'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          'Últimos 7 Días': [moment().subtract(6, 'days'), moment()],
          'Últimos 30 Días': [moment().subtract(29, 'days'), moment()],
          'Este Mes': [moment().startOf('month'), moment().endOf('month')],
          'Mes Pasado': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        },
        locale: {
              format: 'DD/MM/YYYY',
              separator: ' - ',
              applyLabel: 'Aplicar',
              cancelLabel: 'Cancelar',
          }
      }, cb);
      cb(start, end);
      $('.input-placeholder').mask("00/00/0000",
      {
        placeholder: "__/__/____"
      });
      $('.input-zip').mask('00000-000',
      {
        placeholder: "____-___"
      });
      $('.input-money').mask("#.##0,00",
      {
        reverse: true
      });
      $('.input-phoneus').mask('(000) 000-0000');
      $('.input-mixed').mask('AAA 000-S0S');
      $('.input-ip').mask('0ZZ.0ZZ.0ZZ.0ZZ',
      {
        translation:
        {
          'Z':
          {
            pattern: /[0-9]/,
            optional: true
          }
        },
        placeholder: "___.___.___.___"
      });
      
      // Example starter JavaScript for disabling form submissions if there are invalid fields
      (function()
      {
        'use strict';
        window.addEventListener('load', function()
        {
          // Fetch all the forms we want to apply custom Bootstrap validation styles to
          var forms = document.getElementsByClassName('needs-validation');
          // Loop over them and prevent submission
          var validation = Array.prototype.filter.call(forms, function(form)
          {
            form.addEventListener('submit', function(event)
            {
              if (form.checkValidity() === false)
              {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add('was-validated');
            }, false);
          });
        }, false);
      })();
    </script>
    <script>
      var uptarg = document.getElementById('drag-drop-area');
      if (uptarg)
      {
        var uppy = Uppy.Core().use(Uppy.Dashboard,
        {
          inline: true,
          target: uptarg,
          proudlyDisplayPoweredByUppy: false,
          theme: 'dark',
          width: 770,
          height: 210,
          plugins: ['Webcam']
        }).use(Uppy.Tus,
        {
          endpoint: 'https://master.tus.io/files/'
        });
        uppy.on('complete', (result) =>
        {
          console.log('Upload complete! We’ve uploaded these files:', result.successful)
        });
      }
    </script>
    <script src="{% static 'js/apps.js' %}"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56159088-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];

      function gtag()
      {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'UA-56159088-1');
    </script>
    
  </body>
</html>
{% endblock %}